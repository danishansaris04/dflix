<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D-FLIX | Premium Streaming</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700&display=swap');

    :root {
      --primary: #00f2ff; --secondary: #7000ff; --bg-dark: #08090a; --card-bg: #121418; --text-main: #ffffff;
    }
    body.light-mode { --bg-dark: #f0f2f5; --card-bg: #ffffff; --text-main: #121418; }

    body {
      background-color: var(--bg-dark); color: var(--text-main); font-family: 'Outfit', sans-serif;
      padding-bottom: 100px; transition: 0.3s; overflow-x: hidden; margin: 0;
    }

    /* Navbar Fixed */
    .navbar {
      background: rgba(18, 20, 24, 0.9); backdrop-filter: blur(20px);
      margin: 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      padding: 10px 20px; z-index: 5000; position: fixed; top: 0; width: 100%;
    }
    .navbar-brand { color: var(--primary) !important; font-weight: 700; letter-spacing: 1px; }

    /* Universal Search Bar */
    .search-container { 
      padding: 10px 5%; position: fixed; top: 60px; width: 100%; z-index: 4500; 
      background: var(--bg-dark); transition: 0.3s;
    }
    .search-wrapper { position: relative; width: 100%; }
    .search-wrapper i { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: var(--primary); }
    .search-wrapper input {
      width: 100%; background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1);
      padding: 12px 20px 12px 50px; border-radius: 50px; color: var(--text-main); outline: none;
    }

    /* Main Content Area */
    .main-wrapper { margin-top: 155px; }

    /* Trending Banner */
    .trending-box { padding: 0 5%; margin-bottom: 25px; }
    .t-slider {
      width: 100%; height: 140px; border-radius: 20px;
      background: linear-gradient(135deg, var(--secondary), #440099);
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 10px 20px rgba(0,0,0,0.4); text-align: center;
    }

    /* Grids */
    .movie-container { padding: 0 5%; }
    .movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px; }
    
    .m-card {
      position: relative; background: var(--card-bg); border-radius: 15px; overflow: hidden;
      transition: 0.3s ease; animation: fadeInUp 0.5s ease forwards; opacity: 0; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    .m-card img { width: 100%; height: 210px; object-fit: cover; }
    .m-content { 
        position: absolute; bottom: 0; width: 100%; padding: 15px 10px 8px; 
        background: linear-gradient(transparent, rgba(0,0,0,0.9)); 
        font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* Navigation */
    .bottom-nav {
      position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 400px; background: rgba(18, 20, 24, 0.95);
      backdrop-filter: blur(20px); border-radius: 20px;
      display: flex; justify-content: space-around; padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1); z-index: 5000;
    }
    .nav-item { color: #666; text-decoration: none; text-align: center; flex: 1; transition: 0.3s; cursor: pointer; }
    .nav-item.active { color: var(--primary); transform: translateY(-3px); }
    .nav-item span { display: block; font-size: 0.65rem; font-weight: bold; margin-top: 2px; }

    /* Overlays */
    .full-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--bg-dark); z-index: 4000; display: none;
      padding: 160px 20px 80px 20px; overflow-y: auto;
    }
    .history-card { display: flex; gap: 15px; background: var(--card-bg); padding: 10px; border-radius: 12px; margin-bottom: 10px; align-items: center; cursor: pointer;}
    .history-card img { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; }

    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: 700; margin-top: 10px; }
    .see-all { color: var(--primary); font-size: 0.7rem; cursor: pointer; border: 1px solid var(--primary); padding: 2px 10px; border-radius: 5px; }

    @media (max-width: 500px) { .movie-grid { grid-template-columns: repeat(2, 1fr); } }
  </style>
</head>
<body>

  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="javascript:void(0)" onclick="showHome()">D-FLIX</a>
      <i class="fa-solid fa-circle-user fa-2x text-secondary" onclick="toggleSettings()" style="cursor:pointer"></i>
    </div>
  </nav>

  <div class="search-container" id="searchArea">
      <div class="search-wrapper">
          <i class="fa-solid fa-search"></i>
          <input type="text" id="globalSearch" placeholder="Search movies or series...">
      </div>
  </div>

  <div class="main-wrapper">
    <div id="homePage">
        <div class="trending-box">
            <div class="t-slider">
                <div>
                    <h5 class="fw-bold mb-1">WELCOME TO D-FLIX</h5>
                    <p class="small opacity-75 mb-0">Premium Entertainment</p>
                </div>
            </div>
        </div>

        <div class="movie-container">
            <div id="sec-Hollywood" style="display:none">
                <div class="section-header"><span>Latest Movies</span><span class="see-all" onclick="filterType('Hollywood', 'All Movies')">SEE ALL</span></div>
                <div class="movie-grid" id="gridHomeHollywood"></div>
            </div>
            
            <div id="sec-Bollywood" style="display:none">
                <div class="section-header"><span>Bollywood Hits</span><span class="see-all" onclick="filterType('Bollywood')">SEE ALL</span></div>
                <div class="movie-grid" id="gridHomeBollywood"></div>
            </div>

            <div id="sec-WebSeries" style="display:none">
                <div class="section-header"><span>Latest Web Series</span><span class="see-all" onclick="filterType('Web Series')">SEE ALL</span></div>
                <div class="movie-grid" id="gridHomeSeries"></div>
            </div>
        </div>
    </div>

    <div id="fullListView" class="full-overlay">
        <div class="d-flex align-items-center mb-4 px-2">
            <i class="fa-solid fa-arrow-left fa-lg me-3" onclick="showHome()" style="cursor:pointer"></i>
            <h4 id="catTitle" class="mb-0 fw-bold"></h4>
        </div>
        <div class="movie-grid" id="gridFullView"></div>
    </div>
  </div>

  <div id="settingsOverlay" class="full-overlay" style="z-index: 6000; padding-top: 100px;">
      <h2 class="fw-bold mb-4">My Account</h2>
      <div class="history-card" onclick="showHistory()">
          <i class="fa-solid fa-history text-primary"></i> <span class="ms-2">Watch History</span> <i class="fa-solid fa-chevron-right ms-auto"></i>
      </div>
      <div class="history-card">
          <i class="fa-solid fa-moon text-primary"></i> <span class="ms-2">Dark Mode</span>
          <div class="form-check form-switch ms-auto">
              <input class="form-check-input" type="checkbox" checked onchange="document.body.classList.toggle('light-mode')">
          </div>
      </div>
      <button class="btn btn-primary w-100 mt-5 rounded-pill" onclick="showHome()">Back to Home</button>
  </div>

  <div id="historyOverlay" class="full-overlay" style="z-index: 6100; padding-top: 100px;">
      <h4 class="fw-bold mb-4"><i class="fa-solid fa-arrow-left me-3" onclick="toggleSettings()" style="cursor:pointer"></i>Your History</h4>
      <div id="historyList"></div>
      <button class="btn btn-outline-danger w-100 mt-4 rounded-pill" onclick="clearHistory()">Clear History</button>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" id="btnH" onclick="showHome()"><i class="fa-solid fa-house"></i><span>HOME</span></div>
    <div class="nav-item" id="btnM" onclick="filterType('Hollywood', 'All Movies')"><i class="fa-solid fa-film"></i><span>MOVIES</span></div>
    <div class="nav-item" id="btnS" onclick="filterType('Web Series')"><i class="fa-solid fa-play"></i><span>SERIES</span></div>
    <div class="nav-item" onclick="toggleSettings()"><i class="fa-solid fa-gear"></i><span>SETTINGS</span></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyATfDfJNk0lPVpcsZk7yj2p_DSdK9sQXvo",
      authDomain: "dflix-7b2d2.firebaseapp.com",
      projectId: "dflix-7b2d2",
      storageBucket: "dflix-7b2d2.appspot.com",
      messagingSenderId: "410654152125",
      appId: "1:410654152125:web:c55db9c81363abce66eed4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let moviesData = [];

    onSnapshot(collection(db, "movies"), (snap) => {
        moviesData = [];
        snap.forEach(doc => moviesData.push({ id: doc.id, ...doc.data() }));
        renderHome();
    });

    function renderHome() {
        const grids = { 
          'Hollywood': document.getElementById('gridHomeHollywood'), 
          'Bollywood': document.getElementById('gridHomeBollywood'), 
          'Web Series': document.getElementById('gridHomeSeries') 
        };

        Object.values(grids).forEach(g => { if(g) g.innerHTML = ''; });

        const latest = [...moviesData].reverse();
        const counts = { 'Hollywood': 0, 'Bollywood': 0, 'Web Series': 0 };

        latest.forEach(m => {
            const sectionKey = m.section;
            const targetGrid = grids[sectionKey];
            if(targetGrid && counts[sectionKey] < 6) {
                targetGrid.appendChild(createCard(m));
                counts[sectionKey]++;
            }
        });

        document.getElementById('sec-Hollywood').style.display = counts['Hollywood'] > 0 ? 'block' : 'none';
        document.getElementById('sec-Bollywood').style.display = counts['Bollywood'] > 0 ? 'block' : 'none';
        document.getElementById('sec-WebSeries').style.display = counts['Web Series'] > 0 ? 'block' : 'none';
    }

    function createCard(m) {
        const div = document.createElement('div');
        div.className = "m-card";
        div.onclick = () => { saveHistory(m); window.open(m.url, '_blank'); };
        div.innerHTML = `<img src="${m.poster}" onerror="this.src='https://via.placeholder.com/200x300?text=No+Poster'"><div class="m-content">${m.title}</div>`;
        return div;
    }

    window.showHome = () => {
        closeAll();
        document.getElementById('homePage').style.display = 'block';
        document.getElementById('searchArea').style.display = 'block';
        setActive('btnH');
        window.scrollTo(0, 0);
    };

    window.filterType = (section, displayTitle) => {
        closeAll();
        document.getElementById('fullListView').style.display = 'block';
        document.getElementById('searchArea').style.display = 'block';
        // Agar displayTitle diya h toh wo dikhayega nahi toh default section name
        document.getElementById('catTitle').innerText = displayTitle || section;
        
        const grid = document.getElementById('gridFullView');
        grid.innerHTML = '';
        
        const filtered = moviesData.filter(m => m.section === section).reverse();
        if(filtered.length > 0) {
            filtered.forEach(m => grid.appendChild(createCard(m)));
        } else {
            grid.innerHTML = "<p class='text-center w-100 opacity-50 py-5'>Coming Soon...</p>";
        }

        if(section === 'Hollywood' || section === 'Bollywood') setActive('btnM');
        else if(section === 'Web Series') setActive('btnS');
    };

    window.toggleSettings = () => {
        closeAll();
        document.getElementById('settingsOverlay').style.display = 'block';
        document.getElementById('searchArea').style.display = 'none';
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    };

    window.showHistory = () => {
        document.getElementById('historyOverlay').style.display = 'block';
        const list = document.getElementById('historyList');
        const history = JSON.parse(localStorage.getItem('df_history')) || [];
        list.innerHTML = history.length ? '' : '<p class="text-center opacity-50 py-5">History Empty</p>';
        history.forEach(m => {
            const hDiv = document.createElement('div');
            hDiv.className = "history-card";
            hDiv.onclick = () => window.open(m.url, '_blank');
            hDiv.innerHTML = `<img src="${m.poster}"><div><b>${m.title}</b><br><small class="text-primary">${m.section}</small></div><i class="fa-solid fa-play-circle ms-auto text-primary"></i>`;
            list.appendChild(hDiv);
        });
    };

    function saveHistory(m) {
        let h = JSON.parse(localStorage.getItem('df_history')) || [];
        h = h.filter(x => x.title !== m.title);
        h.unshift(m);
        localStorage.setItem('df_history', JSON.stringify(h.slice(0, 25)));
    }

    window.clearHistory = () => { localStorage.removeItem('df_history'); showHistory(); };

    function closeAll() {
        document.getElementById('homePage').style.display = 'none';
        document.getElementById('fullListView').style.display = 'none';
        document.getElementById('settingsOverlay').style.display = 'none';
        document.getElementById('historyOverlay').style.display = 'none';
    }

    function setActive(id) {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active');
    }

    document.getElementById('globalSearch').addEventListener('input', (e) => {
        const val = e.target.value.toLowerCase().trim();
        if(val.length > 0) {
            closeAll();
            document.getElementById('fullListView').style.display = 'block';
            document.getElementById('catTitle').innerText = "Results for: " + val;
            const g = document.getElementById('gridFullView');
            g.innerHTML = '';
            const results = moviesData.filter(m => m.title.toLowerCase().includes(val) || (m.section && m.section.toLowerCase().includes(val)));
            results.length ? results.forEach(m => g.appendChild(createCard(m))) : g.innerHTML = "<p class='text-center w-100 opacity-50 py-5'>No results found</p>";
        } else {
            showHome();
        }
    });

    window.onpopstate = () => showHome();
  </script>
</body>
</html>
